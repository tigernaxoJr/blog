---
title: "[System] 單體式架構 vs 微服務架構"
date: 2021-10-18T11:11:00+08:00
lastmod: 2021-10-18T11:11:00+08:00
draft: true
tags: ["microservice"]
categories: ["DevOps"]
author: "tigernaxo"

autoCollapseToc: false
---
# 單體式與微服務架構
## 單體式架構
以前後端分離的網頁應用程式為例，傳統上大多採用軟體工程**多層式架構(Multitier Architecture)**中的**三層式架構(Three-Tire-Architecture)**，組成如下：
 - **Data tier**: **資料庫(DB)**，有資料表(Table)儲存應用程式資訊。
 - **Logic tier**: 就是**後端(Backend)**、應用程式伺服器 (AP Server)，負責和前端交換資料、存取資料庫。
 - **Presentation tier**: 就是**前端(Frontend)**，提供靜態資源，負責和使用者互動、和後端交換資料。

## 微服務架構
隨著系統愈來愈複雜，為了可維護性、擴充性、開發敏捷性，
透過軟體工程的手段將一個應用程式下**緊密連結(耦合性強)**的服務拆成許多**連結鬆散**且可**獨立部署**的**小型服務**，
小型服務之間透過 HTTP、gRPC... 等通訊協定串聯訊息，構成複雜的應用程式。
這就是微服務架構。

# 服務環境
## 單體式(VM)
一般來說單體式架構較常以 **虛擬機(Virtual Machine)** 的方式來建立單體式架構的各層環境，
VM 將服務從作業系統層面進行隔離(也就是**不同服務有各自獨立的作業系統**)，
VM 相較於實體機器較能夠彈性控管分配資源，
但在啟動速度、硬體資源耗用等等...都需要考慮到各自的作業系統。

## 微服務(容器)
實現微服務架構的核心技術是**容器(Container)**，
容器將執行環境在應用程式層面上隔離，**不同服務共用同一個作業系統**，
相較於傳統單體式架構使用的 VM 技術，容器的優點是耗用的資源少，啟動速度快(因為不用為每個服務建立一個OS)。

# 開發模式
## 單體式
由於所有邏輯都存在同一個服務，
因此開發者通常會被要求了解整個應用程式的運作邏輯，但那是一件很困難(或說不可能)的事，
且會占開發者工作很大一部分，嚴重影響開發效率。
而因為服務都綁定在同一個AP上，使用不同的技術棧進行開發會非常麻煩，所以開發能選擇的工具受到限制

## 微服務
開發者不需要了解整個應用澄式的運作邏輯，可專注於自己開發的部分
由於服務隔離的特性，不同服務容易使用不同的技術棧進行開發，
可以把任務分派到不同團隊
敏捷式(agile)開發
單體式  瀑布(waterfall)開發模式
 - **敏捷性**：拆成為服務的專案更適合敏捷開發，也因為拆成可獨立部屬的小型服務，負責不同小型服務的團隊可以使用不同的技術棧。

# 部屬與擴展
## 單體式
囿於單體式架構的侷限，每當更新版本或修復Bug的時候，
無論是否涉及的商業邏輯範圍大小，
都需要將整個前/後端應用程式重新編譯、部屬，
這對擴展 scaling、負載平衡 Loading balance 都會是一項挑戰。

傳統應用程式負載增加時，應用程式整體架構可以進行如下調整，
 - **橫向擴展**：增加**同一環境**(ex: AP Server)上**可用硬體資源**(CPU、MEMORY、Disk...)。
 - **縱向擴展**：增加**提供服務的環境** (ex: 第二台 AP Server 等等...)，好處是有了**備援機制**，可以達成**負載平衡**。

不論環境是由實體機器/VM/容器所建立，一旦所有的服務都在同一個環境內執行()，就會有下面的缺點：
 - 建立環境時需調整環境相容性來支持每個緊密連結的服務。
 - 每次更版都需要手動部屬，瑣碎麻煩。
 - 負載突增時難以快速釐清區是哪個服務出現問題。
 - 服務出錯時會影響其他服務。

## 微服務
容器化
借助 k8s 等等容器管理平台，容易達到 scaling up、loading balance
可針對負載需求較高的元件進行擴充，避免擴充整個應用程式造成資源(或效能)浪費。資源需求變動的時候也可以自動擴增/縮減 Auto-Scaling。
且修改微服務架構元件的時候不需要觸碰到整個應用程式。

# 運維
使用容器管理平台的微服務開發框架，解決架構管理的複雜問題，讓開發人員可專注於應用開發。
微服務較容易建構 CI/CD ，// why?

# 安全性
但由於微服務各自獨立運作，一但出錯更容易定位，且避免單一服務出錯或超載影響整個應用程式。

# 微服務的挑戰
微服務大幅增加大型應用程式各方面的靈活性，但並非沒有代價，也就是大幅增加複雜度
需要具備能力將服務拆分成可重複使用的微服務，並且每個微服務都需要良好的文件，
微服務具有可重複使用的特性，因此需要透徹了解服務之間的依賴性，審慎評估服務中斷/升級對下游服務的連鎖影響
需要有自動化的系統發展生命周期（英語：System Development Life Cycle，SDLC）、 Event Store 等等...
因此部屬微服務需要非常小心，如果在缺乏自動化 DevOps 流程的團隊，相較於微服務提供的優點反而會帶來更多痛苦




然而一個應用程式(AP)會不同的 Feature 所構成，
Feature 指的可以是 Domain 當中的商業邏輯服務單元(例如購物網站的購物車、商品查詢...)
或任何一項功能(例如資料庫、前端靜態網頁)，
包含靜態網頁資源、資源存取點(Restful API)、WebHook、，或其他類似的服務...，
這些 Feature 在同一台伺服器上共用路由(routing)、中間件(middleware)、和 DB 連線，
當然這些 Feature 中涉及的商業邏輯(Business Logic)也在同一部伺服器上，
以前後端分離的應用程式而言，
不算進資料庫的話，就需要部屬前端靜態網站資源、Web API 這兩種服務。
包含Business Logic的Feature都混在一起放在一個Server裡面。以上圖為例，當Application Layer的Request近來Monolithic Server後，由Router去分配給不同feature的controller去執行business logic並更新和接收DB資料。
在單體架構(Monolithic)下我們把所有的routing, middleware, Business Logic, DB Layer都放在一起去完成一個產品。



# 容器管理平台
目前最主流的容器軟體是 Docker，容器管理平台是 K8S(Kubernetes)

當負載增加就需要擴充硬體資源來因應，
把應用程式部屬到兩台以上的
微服務 + Kubernets 

# 回到 DevOps
傳統流程大約是這樣子的： (todo 修改)
程式開發：由程式設計師開發程式。
測試：開發到一個階段由開發者或測試人員測試、撰寫測試報告。
系統部屬上線：寫腳本建立程式環境、部屬程式。
運維：軟體環境調校和軟體維護作業。

DevOps是什麼？
傳統的產品開發、測試、運維各自作業，
每次程式開發上線的工作流程大同小異(測試、部屬...)且必須人工作業，

DevOps 透過微服務架構整合 Development(開發)、Operation(運維)，
建立自動部屬、自動測試之類的自動化流程，
可大幅縮短開發交付到部屬上線的流程，藉此更精準快速回應市場需求並大幅減少人力成本，
且因為微服務開發框架從根本解決架構管理的複雜問題，
透過自動化流程將運維工程師從瑣碎日常事務當中解放出來，
，讓開發人員可以更專注於應用開發、其他更有價值的工作、學習新技術。

# 硬體
## 硬體資源擴充與服務執行環境隔離

傳統運維的手法？ shell?
#  CICD
上程式的流程自動化

導入現代化 DevOps 帶來什麼好處
方便
安全問題：工程師將編譯的檔案直接放上伺服器，但是程式碼沒有進入版控，會造成混亂。

# Reference
- [第 11 屆 iThome 鐵人賽-就是「懶」才更需要重視DevOps](https://ithelp.ithome.com.tw/users/20120491/ironman/2538)
- [何謂微服務 - 台灣|IBM](https://www.ibm.com/tw-zh/cloud/learn/microservices)
- [medium - 從單體到微服務](https://yunchenli.medium.com/%E5%BE%9E%E5%96%AE%E9%AB%94%E5%88%B0%E5%BE%AE%E6%9C%8D%E5%8B%99-12e206805089)
- [Microservices vs Monolithic Architecture](https://www.mulesoft.com/resources/api/microservices-vs-monolithic)
- [wiki - Multitier architecture](https://en.wikipedia.org/wiki/Multitier_architecture#Three-tier_architecture)
- [wiki - 微服務](https://zh.wikipedia.org/wiki/%E5%BE%AE%E6%9C%8D%E5%8B%99)
- [微服務，敏捷開發方法的關鍵](https://kknews.cc/zh-tw/tech/lmxnrvg.html)